language: python
jobs:
  include:
  - services: docker
    before_install:
    - /opt/python/cp37-cp37m/bin/pip install -i https://pypi.tuna.tsinghua.edu.cn/simple cmake
    - ln -s /opt/python/cp37-cp37m/bin/cmake /usr/bin/cmake
  - os: osx
    language: shell
  - os: windows
    language: shell
    before_install:
      - choco install python --version 3.8.1
      - export PATH="/c/Python38:/c/Python38/Scripts:$PATH"
      - ln -s /c/Python38/python.exe /c/Python38/python3.exe
env:
  global:
  - CIBW_BUILD="cp3?-*"
  - CIBW_MANYLINUX_X86_64_IMAGE="manylinux2014"
  - CIBW_SKIP="cp27-* *-win32 *-manylinux_i686"
  - TWINE_USERNAME=__token__
  - CIBW_BEFORE_BUILD="pip install pybind11 && pip install -i https://pypi.tuna.tsinghua.edu.cn/simple cmake && ($)"
  - CIBW_TEST_COMMAND="cd {project} && python3 -m pip install -U cython pip && python3 -m pip install numpy && python3 setup.py test"
install:
- python3 -m pip install cibuildwheel
script:
- python3 -m cibuildwheel --output-dir wheelhouse
after_success:
- |
  if [[ $TRAVIS_TAG ]]; then
    python3 -m pip install twine
    python3 -m twine upload wheelhouse/*.whl
  fi
